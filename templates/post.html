{% macro post(p, list_mode) %}
{% set _thread = p.thread or p.id %}
<div class="post media {% if p.parent == 0 %}post-original{% else %}post-reply{% endif %}" id="{{ p.id }}">
  <div class="post-header media-heading">
    <a href="{{ url_for('thread_redirect', board=board, thread=_thread) }}#{{ p.id }}" class="post-id">#{{ p.id }}</a>
    {% if p.title %}
      <span class="post-title">{{ p.title }}</span>
    {% endif %}
    <span class="post-timestamp">{{ p.timestamp.strftime('%d.%m.%Y %H:%M:%S') }}</span>
    {% if p.sage %}
      <span class="post-sage"></span>
    {% endif %}
    <a class="glyphicon glyphicon-edit" title="Ответить" class="post-reply-btn" data-toggle="collapse" data-target="#post-form-{{ p.id }}"></a>
  </div>

  <div class="post-content clearfix">
    {% for (fn, thumb) in p.files %}
      <div class="post-attach pull-left">
        <a href="/static/upload/{{ fn }}">
          <img class="media-object" src="/static/thumb/{{ thumb }}" />
        </a>
      </div>
    {% endfor %}

    <div class="post-body media-body">
      {% if list_mode and p.parent != p.thread %}
        <a class="post-parent post-anchor" href="{{ url_for('thread_redirect', board=board, thread=_thread) }}#{{ p.parent }}" data-id="{{ p.parent }}" data-board="{{ board }}">{{ p.parent }}</a><br />
      {% endif %}

      {{ p.text|safe }}
    </div>
  </div>

  <div class="collapse post-form" id="post-form-{{ p.id }}">
    {{ post_form(url_for('thread_redirect', board=board, thread=_thread), _thread, p.id) }}
  </div>
</div>
{% endmacro %}

{% macro post_form(url, thread, parent) %}
<form method="post" role="form" enctype="multipart/form-data" action="{{ url }}">
  <input type="hidden" name="thread" value="{{ thread }}" />
  <input type="hidden" name="parent" value="{{ parent }}" />

  <div class="input-group">
    <input type="text" class="form-control" name="title" placeholder="Тема"></td>
    <label class="input-group-addon" type="checkbox">
      <input type="checkbox" name="sage" />
      Сажа
    </label>
  </div>

  <div class="input-group">
    <!-- TODO: a fancy WYSIWYG text editor. -->
    <textarea class="form-control" name="text" rows="5" cols="60" placeholder="Ценное сообщение"></textarea>
  </div>

  <div class="input-group">
    <input type="file" name="file" />
  </div>

  <div class="input-group">
    <input type="submit" value="{% if thread == 0 %}Создать тред{% else %}Ответить{% endif %}" />
  </div>
</form>
{% endmacro %}
